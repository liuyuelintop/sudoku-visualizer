# 项目复盘：一次关于数据可视化与UI重构的深度探索

本文档旨在记录在开发数独求解器可视化工具的过程中，我们如何面对、分析并解决一系列从表层深入至核心的复杂问题。它不仅是技术修复的备忘录，更是一次关于问题解决思路演进的复盘。

---

### 核心问题一：错误的扫描数据 (The Incorrect Scan Data Bug)

这是我们遇到的第一个，也是最关键的核心算法Bug。

*   **表层现象**: UI上的“`empties`数组可视化”组件显示出完全不合逻辑的行为。例如，当一个候选数为1的最优单元格存在时，扫描过程不仅没有停止，反而将一个候选数更多的单元格标记为“当前最优”，同时扫描指针也停留在一个看似随机的位置。

*   **思维转变与深入**: 最初，我们的直觉是“UI组件的渲染逻辑写错了”。我们反复修改UI组件，试图让它“正确显示”。然而，当所有尝试都失败，且现象越来越“离谱”时，我们迎来了第一个关键的思维转变：**停止怀疑UI，开始质疑供给UI的数据源本身。** 我们意识到，UI可能只是一个忠实的“信使”，它准确地传达了来自核心算法的错误信息。

*   **根本原因**: 带着这个新思路，我们直接审查了核心算法文件 `src/lib/sudoku/solver.ts`。我们发现 `selectMRV` 函数中存在一个致命的逻辑错误：在扫描循环中，当找到一个候选数为1的“完美”单元格时，`break` 语句被立即执行，导致了**记录扫描步骤的 `scan.push()` 操作被跳过**。因此，UI组件收到的 `scan` 数组永远缺少了最关键的、导致扫描结束的那一步数据。

*   **解决方案**: 我们重写了 `selectMRV` 函数中的循环，严格保证了“**先记录，后中断**”的执行顺序。同时，我们加入了“如果前沿单元格已经是‘1’，则跳过扫描”的优化。这次修复从根源上保证了提供给UI的数据的正确性。

---

### 核心问题二：数据的时空悖论 (The Data Time-Paradox Bug)

在解决了数据源的正确性后，我们遇到了第二个更深层次的逻辑问题。

*   **表层现象**: 尽管我们确认 `scan` 数组的数据已经正确，但UI的动画和高亮位置依然是错乱的。`scan` 数组中的索引似乎无法对应到UI上渲染的数组元素。

*   **思维转变与深入**: 此时，我们再次陷入困境。用户（您）提出了一个至关重要的建议：“暂停编码，先理清整个App的数据流”。这是我们的第二个关键思维转变：**从“代码实现”的微观视角，提升到“系统数据流”的宏观视角进行思考。**

*   **根本原因**: 在对数据流的完整梳理中，我们发现了一个“时空悖论”：
    1.  核心算法在 `selectMRV` 中执行了 `swap` 操作。
    2.  然后，它将**交换后**的 `empties` 数组，连同记录着**交换前**索引的 `scan` 和 `swap` 对象，一同打包发给了UI。
    3.  UI组件因此陷入了两难：它拿着一个“未来”的数组（交换后），却要尝试在上面渲染一个发生在“过去”（交换前）的事件。索引的错位在所难免。

*   **解决方案**: 我们设计了“**三阶段可视化**”方案来解决这个悖论。让 `EmptiesArrayVisualizer` 组件变得更“智能”：
    1.  它接收“交换后”的数组和 `swap` 信息，在内部**临时重构出“交换前”的数组状态**。
    2.  **第一阶段（扫描）**: 使用这个临时的“交换前”数组来播放扫描动画，此时所有索引完美匹配。
    3.  **第二阶段（预备交换）**: 动画结束后，在“交换前”的数组上短暂高亮将要交换的双方。
    4.  **第三阶段（完成交换）**: 瞬间切换渲染源为“交换后”的数组，展示最终结果。
    这个方案彻底理顺了UI渲染的时间线，解决了数据不一致的根本问题。

---

### UI/UX 重构：化繁为简

在解决了核心的功能性Bug后，我们着手于优化整体的用户体验。

*   **表层现象**: 页面右侧的分析面板功能重叠、占用空间过大。`Learning mode` 和 `Expert mode` 两个开关概念模糊，交互逻辑不清晰。

*   **思维转变与深入**: 我们不再是“哪里有问题就修补哪里”，而是从**顶层设计的角度**重新思考了“一个好的分析工具应该是什么样的”。

*   **解决方案**: 我们执行了一次彻底的UI净化和重构：
    1.  **合并冗余**: 删除了重复显示候选数的 `MRV Status` 面板。
    2.  **整合布局**: 将所有分析面板收纳进一个**统一的标签页容器**中，极大地节省了空间，并使结构更有条理。
    3.  **统一概念**: 废除了“学习/专家”两个模糊的开关，用一个**“简洁/学习/专家”三档的视图模式切换器**代替，为不同需求的用户提供了清晰、直观的界面选择。

---

### 总结

这次的开发过程是一次宝贵的实践。它清晰地展示了解决复杂问题的一个有效路径：从看似表层的UI Bug出发，通过不断的分析和思维转变，一步步深入到核心算法和数据流，最终定位并解决根本原因。同时，它也证明了在遇到瓶颈时，暂停下来进行宏观的分析和顶层设计，远比在细节上反复修补要更加高效和彻底。
